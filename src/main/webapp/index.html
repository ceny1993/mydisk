<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>文件管理</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/jquery-1.10.2.min.js"></script>
    <script src="js/data.js"></script>
    <script src="js/bootstrap.min.js"></script>
</head>
<body style="margin:50px" oncontextmenu=self.event.returnValue=false>

<div class="form-group">


</div>


<ul id="myTab" class="nav nav-tabs">
    <li class="active"><a href="#upload" data-toggle="tab">上传</a></li>
    <li><a href="#view" data-toggle="tab" onclick="fileList()">查阅</a></li>
</ul>
<div id="myTabContent" class="tab-content">
    <div class="tab-pane fade in active" id="upload" style="width:400px;padding:30px">

        <input type="file" id="file" name="file"/>
        <br />
        <div class="input-group">
            <span class="input-group-addon">文件重命名</span>
            <input id="newName" type="text" class="form-control" placeholder="不需要后缀，可以为空">
        </div>
        <br />
        <div class="input-group">
            <span class="input-group-addon">请输入备注</span>
            <input id="comment" type="text" class="form-control" placeholder="可以为空">
        </div>
        <br />
        <!--<div class="input-group">-->
        <!--<span class="input-group-addon">请输入密码</span>-->
        <!--<input id="password" type="text" class="form-control" placeholder="可以为空(TODO)">-->
        <!--</div>-->
        <!--<br />-->
        <input type="button" value="取消" onclick="location.reload()"/>&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="button" value="上传" onclick="upload()"/>
        <!--<a href="file/download">点击下载</a>-->
        <!--<img src="file/download" width="300px" height="300px">-->
    </div>
    <div class="tab-pane fade" id="view" style="padding:30px">
        <div class="panel-body" style="width:630px">
            <div class="input-group">
                <span class="input-group-addon">请输入关键字</span>
                <input id="keywords" type="text" class="form-control" placeholder="按文件名或备注查找" style="width:400px;height:50px">
                <button type="button" class="btn btn-default btn-lg" style="float:right" onclick="fileSearch()">
                    <span class="glyphicon glyphicon-search"></span>
                </button>
            </div>
        </div>
        <br />
        <div class="panel panel-default">
            <!-- Default panel contents -->
            <div class="panel-heading">上传历史</div>

            <!-- Table -->
            <table class="table" id="uphis">
                <tr>
                    <th>原始文件名</th>
                    <th>新文件名</th>
                    <th>文件类型</th>
                    <th>文件大小(B)</th>
                    <th>上传时间</th>
                    <th>备注</th>
                    <th>查看</th>
                    <th>删除</th>
                </tr>
            </table>
        </div>
    </div>
</div>

<script>
    var data = window.data;
    function upload(){
        var newName = $.trim(document.getElementById("newName").value);
        var comment = $.trim(document.getElementById("comment").value);
        data.upload($('#file')[0].files[0],newName,comment);
    }
    function fileList(){
        $(".tmptr").remove();
        $.get("file/list",function(data){
            processData(data);
        });
    }

    function fileDelete(id){
        $.post("file/delete",{"id":id},function(data){
            alert("删除成功");
            fileList();
        });
    }

    function fileSearch(){
        var keywords = $.trim(document.getElementById("keywords").value);
        if(keywords == ""){
            alert("关键字不能为空");
        }
        else{
            $(".tmptr").remove();
            $.get("file/search?keywords="+keywords,function(data){
                processData(data);
            });
        }
    }

    function fileChange(id,type){
        if(type==1){
            $("#theTitle").text("照片预览");
            $("#theVideo").hide();
            $("#theImg").attr("src","file/download?id="+id);
            $("#theImg").show();

        }

        else if(type==2){
            $("#theTitle").text("视频播放");
            $("#theImg").hide();
            $("#theVideo").attr("src","file/download?id="+id);
            $("#theVideo").show();
        }
    }

    function processData(data){
        for(var i=0;i<data.length;i++){
            var tmp = data[i];
            var a = "<td>"+tmp[3]+"</td>"
            var b = "<td>"+tmp[2]+"</td>";
            var c = "<td>"+tmp[1]+"</td>";
            var d = "<td>"+tmp[4]+"</td>";
            var e = "<td>"+tmp[5]+"</td>";
            var f = "<td>"+tmp[6]+"</td>";
            var g;
            if(tmp[1].startsWith("image")){
                g = "<td><button type='button' class='btn btn-primary' data-toggle='modal' data-target='.modal' onclick='fileChange(" +tmp[0]+ ",1)'>预览</button></td>"
            }
            else if(tmp[1].startsWith("video")){
                g = "<td><button type='button' class='btn btn-primary' data-toggle='modal' data-target='.modal' onclick='fileChange("+tmp[0]+",2)'>播放</button></td>"
            }
            else{
                g = "<td></td>"
            }
            var h = "<td><button type='button' class='btn btn-primary' onclick='fileDelete("+tmp[0]+")'>删除</button></td>"
            <!--var g = "<td><a href = 'file/download?id="+tmp[0]+"'>点击下载</a></td>";-->
            <!--var h = "<td><a href = '#' onclick='fileDelete("+tmp[0]+")'>点击删除</a></td>";-->
            $("#uphis").append("<tr class = 'tmptr'>"+a+b+c+d+e+f+g+h+"</tr>");
        }
    }

</script>


<!-- modal -->
<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 id="theTitle" class="modal-title"></h4>
            </div>
            <div class="modal-body text-center">
                <img id="theImg" width="500px" height="auto">
                <video id="theVideo" controls="controls" width="500px"/>
            </div>
        </div>
    </div>
</div>
</body>
</html>